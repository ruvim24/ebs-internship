@page "/test"
@using System.Text.Json
@using API.Client.Services
@using Shared.Dtos.Appointments
@using Shared.Dtos.Cars
@using Shared.Dtos.Services
@using Shared.Dtos.Slots
@using Shared.Dtos.Users
@using Shared.Validators.Cars
@inject AccountService AccountService
@inject CarService CarService
@inject ServicesService ServicesService
@inject SlotsService SlotService

@if (servicesExists)
{
    <MudPaper Style="width: 800px">
    <MudStepper Vertical ShowResetButton bind-ActiveStepIndex="activeStepIndex">
        
        <ChildContent>
            @*Car Registration*@
            @if (userHasCar)
            {
                <MudStep Title="Register Your Car">
                    <MudCard Elevation="6" Style="width: 100%; max-width: 500px; padding: 30px; border-radius: 15px; background-color: #ffffff; margin: auto;">
                        <MudCardContent>
                            <MudText Typo="Typo.h5" Align="Align.Center" Style="color: #1976d2;">Register Your Car</MudText>
                            <MudForm @ref="_form" Model="createCarModel" Validation="@(createCarValidator.ValidateValue)" ValidationDelay="0">
                                <MudCardContent>
                                    <MudTextField @bind-Value="createCarModel.Maker"
                                                  For="@(() => createCarModel.Maker)"
                                                  Immediate="true"
                                                  Label="Car Maker"
                                                  Variant="Variant.Filled"
                                                  Margin="Margin.Dense"
                                                  Style="background-color: #f5f5f5;"/>

                                    <MudTextField @bind-Value="createCarModel.Model"
                                                  For="@(() => createCarModel.Model)"
                                                  Immediate="true"
                                                  Label="Car Model"
                                                  Variant="Variant.Filled"
                                                  Margin="Margin.Dense"
                                                  Style="background-color: #f5f5f5;"/>

                                    <MudTextField @bind-Value="createCarModel.PlateNumber"
                                                  For="@(() => createCarModel.PlateNumber)"
                                                  Immediate="true"
                                                  Label="Number Plate"
                                                  Variant="Variant.Filled"
                                                  Margin="Margin.Dense"
                                                  Style="background-color: #f5f5f5;"/>

                                    <MudTextField @bind-Value="createCarModel.VIN"
                                                  For="@(() => createCarModel.VIN)"
                                                  Immediate="true"
                                                  Label="VIN"
                                                  Variant="Variant.Filled"
                                                  Margin="Margin.Dense"
                                                  Style="background-color: #f5f5f5;"/>
                                </MudCardContent>
                            </MudForm>
                        </MudCardContent>
                        <MudCardActions>
                            <MudButton FullWidth="true" Variant="Variant.Filled" Color="Color.Primary" Style="margin-top: 16px;" Disabled="!_form.IsValid" OnClick="SubmitCar">Submit</MudButton>
                        </MudCardActions>
                    </MudCard>
                </MudStep>
            }

            @*Service Selection*@
            <MudStep Title="Select desired service">
                <MudCard Elevation="6" Style="width: 100%; max-width: 500px; padding: 30px; border-radius: 15px; background-color: #ffffff; margin: auto;">
                    <MudCardContent>
                        <MudText Typo="Typo.h5" Align="Align.Center" Style="color: #1976d2;">Select Your Service</MudText>
                        <MudForm @ref="_form" Model="serviceDto">
                            <MudCardContent>
                                <MudSelect @bind-Value="serviceDto.Id" Label="Choose Service" Variant="Variant.Text" Margin="Margin.Dense" Style="background-color: #f5f5f5;">
                                    @foreach (var service in serviceList)
                                    {
                                        <MudSelectItem Value="@service.Id">
                                            <MudText Typo="Typo.body1">@service.Name</MudText>
                                            <MudText Typo="Typo.body2" Color="Color.Info">@service.Description</MudText>
                                            <MudText Typo="Typo.body2" Color="Color.Primary">@($"${service.Price}")</MudText>
                                        </MudSelectItem>
                                    }
                                </MudSelect>
                            </MudCardContent>
                        </MudForm>
                    </MudCardContent>

                    <MudCardActions>
                        <MudButton FullWidth="true" Variant="Variant.Filled" Color="Color.Primary" Style="margin-top: 16px;" Disabled="!_form.IsValid" OnClick="SubimtService">Submit</MudButton>
                    </MudCardActions>
                </MudCard>
            </MudStep>

            @* Time Appointment Selection*@
            <MudStep Title="Select appointment Date">

                <MudCard Elevation="6" Style="width: 100%; max-width: 500px; padding: 30px; border-radius: 15px; background-color: #ffffff; margin: auto;">
                    <MudDatePicker Variant="Variant.Text" Label="Select Date" HelperText="@_day?.ToShortDateString()" @bind-Date="_day" FixYear="@DateTime.Today.Year"  DateFormat="dd/MM/yyyy"/>
                    <MudCardActions>
                        <MudButton Style="width: 100%" OnClick="SubmitDate" Variant="Variant.Filled" EndIcon="@Icons.Material.Filled.Done" Color="Color.Primary">Confirm Date</MudButton>
                    </MudCardActions>

                    @*Select Time*@
                    <MudCardContent>
                        @if (slotList.Any())
                        {
                            <MudSelect T="int" bind-Value="appointmentDto.SlotId" Label="Select Time" Variant="Variant.Text">
                                @foreach (var slot in slotList)
                                {
                                    <MudSelectItem Value="slot.Id">@($"{slot.StartTime.ToString("H:mm")} - {slot.EndTime.ToString("H:mm")}")</MudSelectItem>
                                }
                            </MudSelect>
                        }
                        else
                        {
                            <MudAlert Severity="Severity.Warning" NoIcon="true" Class="my-2">@($"No available time for {_day.Value.Date.ToString("d")}, choose another time!")</MudAlert>
                        }

                        @if (slotList.Any())
                        {
                            <MudButton Style="width: 100%" OnClick="SumbmitTime" Variant="Variant.Filled" EndIcon="@Icons.Material.Filled.Done" Color="Color.Primary">Confirm Time</MudButton>
                        }
                        
                    </MudCardContent>
                </MudCard>
            </MudStep>

            <MudStep Title="Confirm Appointment">
                <MudCard Elevation="5" Style="width: 300px; padding: 20px; margin: auto; border-radius: 10px;">
                    <MudCardContent>
                        <MudText Typo="Typo.h6" Align="Align.Start" Style="color: #333;">Appointment Details</MudText>
                        <MudText Typo="Typo.body2" Align="Align.Start" Style="color: #555; margin-top: 10px;">
                            <strong>Name:</strong> @(serviceDto.Name.ToString())
                        </MudText>

                        <MudText Typo="Typo.body2" Align="Align.Start" Style="color: #555; margin-top: 10px;">
                            <strong>Price: </strong> @(serviceDto.Price.ToString())
                        </MudText>

                        <MudText Typo="Typo.body2" Align="Align.Start" Style="color: #555; margin-top: 10px;">
                            <strong>Duration: </strong> @(serviceDto.Duration.ToString())
                        </MudText>
                        
                        
                        <MudText Typo="Typo.body2" Align="Align.Start" Style="color: #555; margin-top: 10px;">
                            <strong>Time: </strong> @(appointmentTime.Date.ToString("t"))
                        </MudText>
                    </MudCardContent>
                    
                    @if (appointmentDto != null)
                    {
                        <MudButton Style="width: 100%" OnClick="ConfirmAppointment" Variant="Variant.Filled" EndIcon="@Icons.Material.Filled.Done" Color="Color.Primary">Confirm Appointment</MudButton>

                    }
                </MudCard>
            </MudStep>


        </ChildContent>
        <CompletedContent>
            Appointmet succesefully saved!!
        </CompletedContent>
    </MudStepper>
</MudPaper>
}
else
{
    <p> no service exist, you can't create an appointment</p>
}

<br/>

@code
{
    MudForm _form;
    CreateCarDto createCarModel = new();
    CreateCarDtoValidator createCarValidator = new();
    ServiceDto serviceDto = new();
    UserDto currentUser = new();
    bool userHasCar;
    CarDto userCar = new();
    bool servicesExists;
    IEnumerable<ServiceDto> serviceList;
    IEnumerable<SlotDto> slotList;
    DateTime? _day { get; set; }
    CreateAppointmentDto appointmentDto = new();

    DateTime appointmentTime;

    private int activeStepIndex = 0;
    
    protected override async Task OnInitializedAsync()
    {
        currentUser = await AccountService.GetLoggedInUser();
        var response = await CarService.GetCustumerCar(currentUser.Id);
        if (response.IsSuccessStatusCode)
        {
            userCar = JsonSerializer.Deserialize<CarDto>(await response.Content.ReadAsStringAsync());
            userHasCar = true;
        }
        else
        {
            userHasCar = false;
        }
        
        var servicesResponse = await ServicesService.GetServicesAsync();
        var options = new JsonSerializerOptions() { PropertyNameCaseInsensitive = true };
        var services = JsonSerializer.Deserialize<IEnumerable<ServiceDto>>(await servicesResponse.Content.ReadAsStringAsync(), options);
        if (services != null)
        {
            serviceList = services;
            servicesExists = true;
        }

    }

    private async Task SubmitDate()
    {
        if (_day.HasValue || serviceDto.MasterId > 0)
        {
            IEnumerable<SlotDto>? availableSlotList;
            
            availableSlotList = await SlotService.GetMastersAvailableSlotsForDate(serviceDto.MasterId);
            
            var utcDay = _day.Value.ToUniversalTime();
            utcDay = utcDay.AddDays(1);
            if (availableSlotList != null) slotList = availableSlotList.Where((SlotDto x) => _day != null && x.StartTime.Date == utcDay.Date).ToList();
        }
    }

    private void SubmitCar()
    {
        GoToStep(userHasCar? 1:2);
    }

    private void SubimtService()
    {
        serviceDto = serviceList.Where(x => x.Id == serviceDto.Id).First();
        GoToStep(servicesExists? 2:3);
    }

    private void SumbmitTime()
    {
        var slot = slotList.Where(x => x.Id == appointmentDto.SlotId).FirstOrDefault();
        appointmentTime = slot.StartTime;
    }

    private void ConfirmAppointment()
    {
        
    }
    
    private void GoToStep(int stepIndex)
    {
        activeStepIndex = stepIndex;
    }
}



