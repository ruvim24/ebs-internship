@using System.Text.Json
@using API.Client.Services
@using Shared.Dtos
@using Shared.Dtos.Cars
@inject NavigationManager Navigation
@inject CarService CarService
@inject ISnackbar Snackbar
@inject IDialogService DialogService

@if (carExists)
{
    <MudCard Elevation="6" Style="width: 100%; max-width: 400px; border-radius: 15px; text-align: left; margin: auto;">
        <MudCardHeader>
            <MudText Typo="Typo.h5" Align="Align.Center">Car Information</MudText>
        </MudCardHeader>

        <MudCardContent>
            <MudStack Spacing="3">
                <MudText Typo="Typo.subtitle1" Color="Color.Primary">Maker:</MudText>
                <MudText Typo="Typo.body1">@carDetails.Maker</MudText>

                <MudText Typo="Typo.subtitle1" Color="Color.Primary">Model:</MudText>
                <MudText Typo="Typo.body1">@carDetails.Model</MudText>

                <MudText Typo="Typo.subtitle1" Color="Color.Primary">Plate Number:</MudText>
                <MudText Typo="Typo.body1">@carDetails.PlateNumber</MudText>

                <MudText Typo="Typo.subtitle1" Color="Color.Primary">VIN:</MudText>
                <MudText Typo="Typo.body1">@carDetails.VIN</MudText>
            </MudStack>
        </MudCardContent>

        <MudCardActions>
            <MudButton Variant="Variant.Filled" OnClick="EditCar" Color="Color.Primary">Edit</MudButton>
        </MudCardActions>
    </MudCard>

}
else
{
    <MudButton Variant="Variant.Filled" OnClick="CarRegistration" Color="Color.Primary">Register your car</MudButton>

}

@code {

    [Parameter] public int CustomerId { get; set; }
    bool carExists = true;

    CarDto carDetails { get; set; }
    UpdateCarDto carEdit { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var response = await CarService.GetCustumerCar(CustomerId);
        if (response.IsSuccessStatusCode)
        {
            string carJson = await response.Content.ReadAsStringAsync();

            var options = new JsonSerializerOptions()
            {
                PropertyNameCaseInsensitive = true
            };
            carDetails = JsonSerializer.Deserialize<CarDto>(carJson, options);

            carEdit = new UpdateCarDto()
            {
                Id = carDetails.Id,
                Maker = carDetails.Maker,
                Model = carDetails.Model,
                PlateNumber = carDetails.PlateNumber,
                VIN = carDetails.VIN
            };
        }
        else
        {
            carExists = false;
        }

    }

    private async Task EditCar()
    {
        var parameters = new DialogParameters { { "carEdit", carEdit } };

        var dialog = DialogService.Show<EditCarDialog>("Edit car information", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            carEdit = (UpdateCarDto)result.Data;
            var response = await CarService.UpdateCar(carEdit);

            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Saved", Severity.Success);
                Navigation.NavigateTo(Navigation.Uri, forceLoad: true);
            }
            else
            {
                Snackbar.Add("Saving error", Severity.Warning);
            }

        }
        else
        {
            Snackbar.Add("Edit canceled", Severity.Info);
        }
    }

    public async Task CarRegistration()
    {
        var dialog = DialogService.Show<CreateCar>("Car registration");
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            var car = (CreateCarDto)result.Data;

            car.CustomerId = CustomerId; //for current user

            var response = CarService.CreateCar(car);
            if (response.IsCompletedSuccessfully)
            {
                Snackbar.Add("Car was registred", Severity.Success);
                Navigation.NavigateTo(Navigation.Uri, forceLoad: true);

            }

            Snackbar.Add("Registration error", Severity.Error);
        }

        Snackbar.Add("Car registration canceled", Severity.Info);

    }
    
}